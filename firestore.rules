rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function hasOnlyAllowedFields(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }

    function isNonEmptyString(value, max) {
      return value is string && value.size() > 0 && value.size() <= max;
    }

    allow read, write: if false; // 默认拒绝，具体集合再单独授权

    match /mainCareers/{careerId} {
      function validCareerPayload() {
        return (
          hasOnlyAllowedFields([
            'user_uid',
            'title',
            'status',
            'createdAt',
            'activatedAt',
            'archivedAt',
            'totalFocusSec',
            'totalSessions'
          ]) &&
          request.resource.data.user_uid is string &&
          request.resource.data.status in ['active', 'archived'] &&
          isNonEmptyString(request.resource.data.title, 30) &&
          request.resource.data.createdAt is timestamp &&
          request.resource.data.activatedAt is timestamp &&
          request.resource.data.totalFocusSec is int &&
          request.resource.data.totalFocusSec >= 0 &&
          request.resource.data.totalSessions is int &&
          request.resource.data.totalSessions >= 0 &&
          (!('archivedAt' in request.resource.data) || request.resource.data.archivedAt is timestamp)
        );
      }

      allow get, list: if resource != null && isOwner(resource.data.user_uid);
      allow create: if isOwner(request.resource.data.user_uid) && validCareerPayload();
      allow update: if isOwner(resource.data.user_uid) && validCareerPayload();
      allow delete: if false;
    }

    match /sessions/{sessionId} {
      function validSessionCreate() {
        return (
          hasOnlyAllowedFields(['user_uid', 'mainCareerId', 'startAt', 'durationSec', 'dayKey', 'createdAt']) &&
          request.resource.data.user_uid is string &&
          request.resource.data.mainCareerId is string &&
          request.resource.data.startAt is string &&
          request.resource.data.durationSec is int &&
          request.resource.data.durationSec >= 0 &&
          request.resource.data.dayKey is string &&
          request.resource.data.createdAt is timestamp
        );
      }

      allow get, list: if resource != null && isOwner(resource.data.user_uid);
      allow create: if isOwner(request.resource.data.user_uid) && validSessionCreate();
      allow update, delete: if false; // 会话记录写入后不允许修改/删除
    }

    match /daily_stats/{statId} {
      function validDailyStat() {
        return (
          hasOnlyAllowedFields(['user_uid', 'dayKey', 'totalFocusSec', 'totalSessions', 'updatedAt']) &&
          request.resource.data.user_uid is string &&
          request.resource.data.dayKey is string &&
          request.resource.data.totalFocusSec is int &&
          request.resource.data.totalFocusSec >= 0 &&
          request.resource.data.totalSessions is int &&
          request.resource.data.totalSessions >= 0 &&
          request.resource.data.updatedAt is timestamp
        );
      }

      allow get, list: if isOwner(resource.data.user_uid);
      allow create, update: if isOwner(request.resource.data.user_uid) && validDailyStat();
      allow delete: if false;
    }

    match /weekly_stats/{statId} {
      function validWeeklyStat() {
        return (
          hasOnlyAllowedFields(['user_uid', 'weekKey', 'totalFocusSec', 'totalSessions', 'updatedAt']) &&
          request.resource.data.user_uid is string &&
          request.resource.data.weekKey is string &&
          request.resource.data.totalFocusSec is int &&
          request.resource.data.totalFocusSec >= 0 &&
          request.resource.data.totalSessions is int &&
          request.resource.data.totalSessions >= 0 &&
          request.resource.data.updatedAt is timestamp
        );
      }

      allow get, list: if isOwner(resource.data.user_uid);
      allow create, update: if isOwner(request.resource.data.user_uid) && validWeeklyStat();
      allow delete: if false;
    }

    match /global_stats/{uid} {
      function validGlobalStat() {
        return (
          hasOnlyAllowedFields(['user_uid', 'totalFocusSec', 'totalSessions', 'updatedAt']) &&
          request.resource.data.user_uid is string &&
          request.resource.data.totalFocusSec is int &&
          request.resource.data.totalFocusSec >= 0 &&
          request.resource.data.totalSessions is int &&
          request.resource.data.totalSessions >= 0 &&
          request.resource.data.updatedAt is timestamp
        );
      }

      allow get, list: if resource != null && isOwner(resource.data.user_uid);
      allow create, update: if isOwner(request.resource.data.user_uid) && validGlobalStat();
      allow delete: if false;
    }

    match /users/{uid} {
      function validUserPayload() {
        return (
          hasOnlyAllowedFields(['activeMainCareerId', 'totalFocusSec', 'todayFocusSec', 'todayKey']) &&
          (request.resource.data.activeMainCareerId is string || request.resource.data.activeMainCareerId == null) &&
          request.resource.data.totalFocusSec is int &&
          request.resource.data.totalFocusSec >= 0 &&
          request.resource.data.todayFocusSec is int &&
          request.resource.data.todayFocusSec >= 0 &&
          request.resource.data.todayKey is string
        );
      }

      allow get, list: if isOwner(uid);
      allow create, update: if isOwner(uid) && validUserPayload();
    }

    match /users/{uid}/active_session/{docId} {
      function validActiveSessionWrite() {
        return (
          hasOnlyAllowedFields(['mainCareerId', 'startAt', 'durationSec', 'deviceId', 'heartbeatAt', 'status']) &&
          request.resource.data.mainCareerId is string &&
          request.resource.data.startAt is string &&
          request.resource.data.durationSec is int &&
          request.resource.data.durationSec >= 0 &&
          isNonEmptyString(request.resource.data.deviceId, 200) &&
          request.resource.data.heartbeatAt is string &&
          request.resource.data.status in ['active', 'ended']
        );
      }

      allow get, list: if isOwner(uid);
      allow create, update: if isOwner(uid) && validActiveSessionWrite();
      allow delete: if isOwner(uid);
    }

    // 多设备互斥（单 active session）的强一致性无法仅靠规则表达，
    // 需在客户端/后台通过 transaction 检查 status/deviceId 保证。
  }
}
